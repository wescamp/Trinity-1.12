#textdomain wesnoth-Trinity

[scenario]
    id="3_H05"
    name= _ "Seance"
    map_data="{~add-ons/Trinity/maps/3_H05pre.map}"
    next_scenario=3_K05
    victory_when_enemies_defeated=no
    {TURNS 25 15 10}

    [music]
        name="nunc_dimittis.ogg"
    [/music]

    #	{BMR_STORE_SIDE 1}
    #	{BMR_RESTORE_SIDE 1}
    {FIRST_WATCH}

    [story]
        [part]
            story= _ "As Haldrad's party headed back toward Weldyn, Dolevan's mind was racing. He had been in periodic contact with his brother Malevan for years, but he had not heard from him for over a year and a half.  In his last letter, Malevan related that he had been studying some powerful ancient culture, and had been trying to extract some of the lost knowledge and power. Dolevan wasn't sure, but he suspected the red-eyed stranger was related to his brother's work."
            background="story/landscape-plain.jpg"
        [/part]
        [part]
            story= _ "The group had just emerged from the foothills and were gazing across the plains towards Weldyn when they heard a rumble and saw a black plume of smoke emerge from the city. Dolevan shrank back into the shadows, flipping through his papers to see if his brother's letters contained anything relevant to the situation."
            background="story/landscape-bridge.jpg"
        [/part]
        [part]
            story= _ "Dardrus froze in place when he saw the smoke emanating from the city.
'I have seen this before...  What do you know of, uh, green-eyed traitors?'
'What are you talking about?,' answered Prince Haldrad.  Dolevan skimmed the letters for something about green eyes: nothing.
'The enemy is not strong, but is very devious.  They do not have bodies of their own, but they take control of vulnerable prey such as yourselves-'
'You know all of this from a black puff of smoke?,' interrupted the prince.
'No...  We fought against this enemy, it was a desperate battle to save the world - your people included.  We did not lose, but neither did we win.  The enemy is out there, and I've seen them responsible for such black plumes in the past.' " 
            background="story/landscape-bridge.jpg"
        [/part]
        [part]
            story= _ "Dolevan searched for some mention of battles or war in his brother's letters. He found a speculation that humans had been enslaved by beings of great strength, and that the common enemy was the 'lower half'. He didn't know what 'lower half' meant, he suspected it was a bad translation by his brother, but this information suggested that Dardrus was not to be trusted."
            background="story/Trinity_swamp.jpg"
        [/part]
        [part]
            story= _ "Prince Haldrad directed the group to head to Weldyn, in case they could provide assistance to the city defenders. They had gone a couple of miles before Haldrad realized Dolevan and his undead minions were no longer with them. He called out, but knew it was pointless for the Necromancer did not want to be with them..."
            background="story/landscape-bridge.jpg"
        [/part]
    [/story]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Dolevan gets a Khthon kill (Thralls don't count)"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dolevan"
            [/objective]
            [objective]
                condition=lose
                description=_ "Time Runs Out"
            [/objective]
            note=_"This is the only scenario where you play as Dolevan."
        [/objectives]
        {GENERIC_UNIT 1 "Revenant" 12 2}
        {GENERIC_UNIT 1 "Bone Shooter" 14 2}
        [unit]
            id=Khthon1
            profile=portraits/elves/transparent/ranger.png~BLIT(portraits/ker.png,0,0)~CS(-110,5,-5)
            type=Elvish Avenger
            gender=male
            side=2
            x,y=13,2
        [/unit]
        [unit]
            id=Khthon2
            type=OphisMagnum
            side=2
            x,y=14,10
        [/unit]
        [unit]
            id=Khthon3
            type=Elvish Scout
            side=2
            x,y=5,9
        [/unit]
        {ARCHAIC_KHTHONIZED id=Khthon1}
        {ARCHAIC_KHTHONIZED id=Khthon3}
        [store_unit]
            [filter]
                id=Khthon1
            [/filter]
            variable=khthon1
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Khthon2
            [/filter]
            variable=khthon2
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Khthon3
            [/filter]
            variable=khthon3
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Khthon_Leader
            [/filter]
            variable=khthon_leader
            kill=yes
        [/store_unit]
    [/event]

    {ARCHAIC_KHTHON_RECRUITS (
        side=2
        [not]
            race=khthon
        [/not]
    )}

    [side]
        type=Necromancer
        #	save_id=Royal
        name="Dolevan"
        id=Dolevan
        side=1
        canrecruit=yes
        controller=human
        fog=no
        recruit=Skeleton, Skeleton Archer, Walking Corpse
        {GOLD 150 125 100}
        {INCOME 6 4 2}
        team_name=Undead
    [/side]

    [side]
        type=Noble_Beast
        id=Khthon_Leader
        canrecruit=yes
        recruit=Horse, Peasant, Woodsman, Ruffian
        side=2
        controller=ai
        fog=no
        {GOLD 100 150 200}
        {INCOME 2 5 8}
        [ai]
#            aggression=0.8
#            grouping=offensive
#            caution=0.9
        [/ai]
        team_name=Khthon
    [/side]

    [side]
        no_leader=yes
        side=3
        controller=ai
        fog=no
        [ai]
            aggression=0.8
            grouping=offensive
            caution=0.9
        [/ai]
        team_name=Humans
    [/side]

    [side]
        no_leader=yes
        side=4
        controller=ai
        fog=no
        [ai]
            aggression=0.8
            grouping=offensive
            caution=0.9
        [/ai]
        team_name=Phantom
    [/side]

    [event]
        name=start
        [message]
            speaker=Dolevan
            message= _ "(I don't trust that stranger, but I don't know what to do and Malevan's letters are just confusing. I'll shadow the Prince, see if - what's that?)"
        [/message]
        [music]
            name=frantic.ogg
            append=no
            immediate=yes
        [/music]
        [move_unit_fake]
            type=Cavalryman
            x=16,10
            y=9,6
            side=3
        [/move_unit_fake]
        [unit]
            type=Cavalryman
            side=3
            id=Human1
            x,y=10,6
            facing=ne
        [/unit]
        [message]
            speaker=Human1
            message= _ "Weldyn has fallen! Run for your life, old man!"
        [/message]
        {MODIFY_UNIT id=Human1 facing sw}
        {MOVE_UNIT id=Human1 6 8}
        [unstore_unit]
            variable=khthon3
        [/unstore_unit]
        [scroll_to]
            x,y=6,8
        [/scroll_to]
        [delay]
            time=300
        [/delay]
        [message]
            speaker=Human1
            message= _ "Ghah!!"
        [/message]
        {MODIFY_UNIT id=Human1 facing se}
        {MOVE_UNIT id=Human1 13 10}
        [unstore_unit]
            variable=khthon2
        [/unstore_unit]
        {MODIFY_UNIT id=Khthon2 facing nw}
        [scroll_to]
            x,y=13,10
        [/scroll_to]
        [delay]
            time=500
        [/delay]
        [animate_unit]
            flag=attack
            [filter]
                id=Khthon2
            [/filter]
            [primary_attack]
                name=khthon_vector
            [/primary_attack]
            hits=yes
        [/animate_unit]
        {ARCHAIC_KHTHONIZED id=Human1}
        [sound]
            name=slowed.wav
        [/sound]
        {BMR_FLOATING_TEXT id=Human1 0,100,200 "Posessed!"}
        [message]
            speaker=Human1
            message= _ "..."
        [/message]
        [redraw][/redraw]
        [delay]
            time=400
        [/delay]
        [message]
            speaker=Dolevan
            message= _ "(What am I seeing? What are those things?)"
        [/message]
        {MOVE_UNIT (id=Human1) 1 12}
        [kill]
            id=Human1
        [/kill]
        [kill]
            id=Khthon2
        [/kill]
        [kill]
            id=Khthon3
        [/kill]
        [delay]
            time=400
        [/delay]
        [unstore_unit]
            variable=khthon1
        [/unstore_unit]
        {MODIFY_UNIT id=Khthon1 facing s}
        [message]
            speaker=Khthon1
            message= _ "Hisss!"
        [/message]
        {MODIFY_UNIT id=Dolevan facing n}
        [animate_unit]
            flag=attack
            [filter]
                id=Dolevan
            [/filter]
            [primary_attack]
                name=plague staff
            [/primary_attack]
            hits=yes
        [/animate_unit]
        {MODIFY_UNIT x,y=12,2 facing ne}
        {MODIFY_UNIT id=Khthon1 facing sw}
        [animate_unit]
            flag=attack
            [filter]
                x,y=12,2
            [/filter]
            [primary_attack]
                name=axe
            [/primary_attack]
            hits=yes
        [/animate_unit]
        [message]
            speaker=Dolevan
            message= _ "Join my undead, foul one!"
        [/message]
        [animate_unit]
            flag=attack
            [filter]
                id=Dolevan
            [/filter]
            [primary_attack]
                name=plague staff
            [/primary_attack]
            hits=yes
        [/animate_unit]
        [kill]
            id=Khthon1
            animate=yes
        [/kill]
        [item]
            x,y=13,2
            image="units/elves-wood/avenger-die4.png~RC(magenta>blue)"
        [/item]
        [message]
            speaker=Dolevan
            message= _ "Hmmm...  I think it's dead..."
        [/message]
        [unit]
            side=3
            type=Duelist
            id=Lyron
            name="Advisor Lyron"
            x,y=15,7
            facing=nw
        [/unit]
        [unit]
            side=3
            type=Fencer
            x,y=16,8
            facing=nw
        [/unit]
        [unit]
            side=3
            type=Spearman
            x,y=16,7
            facing=nw
        [/unit]
        [message]
            speaker=Lyron
            message= _ "What have you there, Dolevan?"
        [/message]
        {MODIFY_UNIT (id=Dolevan) facing se}
        [message]
            speaker=Dolevan
            message= _ "Lyron...  What is going on?  Has Weldyn fallen?  To what enemy?"
        [/message]
        [message]
            speaker=Lyron
            message= _ "I was trying to smooth ruffled feathers in Carcyn, so I am not too sure how it happened, but yes, it appears Weldyn has fallen.  I am not sure what foes, but my contacts say it was elves."
        [/message]
        [message]
            speaker=Lyron
            message= _ "In any case, I wouldn't stay around here.  More like your dead friend there are wandering around."
        [/message]
        {MOVE_UNIT (id=Lyron) 16 6}
        [kill]
            side=3
        [/kill]
        {MODIFY_UNIT (id=Dolevan) facing nw}
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Dolevan
            message= _ "I must figure out what these things are, what drives them..."
        [/message]
        [delay]
            time=1000
        [/delay]
        {MODIFY_UNIT (id=Dolevan) facing se}
        [delay]
            time=1000
        [/delay]
        {MODIFY_UNIT (id=Dolevan) facing sw}
        [message]
            speaker=Dolevan
            message= _ "I'm not going to learn anything by poking at this corpse.  A seance may be necessary..."
        [/message]
        {MOVE_UNIT (id=Dolevan) 13 1}
        {FLASH_WHITE (
            [message]
                speaker=Dolevan
                message= _ "<i>Departed Spirit, tell me who you are...</i>"
            [/message]
        )}
        [delay]
            time=1000
        [/delay]
        {MODIFY_UNIT (id=Dolevan) facing se}
        [delay]
            time=1000
        [/delay]
        {MODIFY_UNIT (id=Dolevan) facing sw}
        [message]
            speaker=Dolevan
            message= _ "I think I almost had it...  I felt a presence.  Let's try that again."
        [/message]
        {FLASH_WHITE (
            [message]
                speaker=Dolevan
                message= _ "<i>Departed Spirit, do not flee.  I only wish to learn from you...</i>"
            [/message]
        )}
        [message]
            speaker=Dolevan
            message= _ "No, there are no answers there.  It's like asking questions of a walking corpse.  If I can capture one of those responsible for this plague, I should get my answers."
        [/message]
        [unstore_unit]
            variable=khthon_leader
        [/unstore_unit]
        [message]
            speaker=Khthon_Leader
            message= _ "Neyyyy!"
        [/message]
        [message]
            speaker=Dolevan
            message= _ "Is that one of them?  This is my lucky day...  I can get answers from that thing."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            race=undead
            [not]
                type="Walking Corpse"
            [/not]
        [/filter]
        [message]
            speaker=Dolevan
            message=_"I feel I don't have the best resources at hand here...  But I can summon at least one spirit."
        [/message]
        [unit]
            side=1
            type=Ghost
            id=Ghost1
            x,y=1,1
        [/unit]
        [message]
            speaker=Ghost1
            message=_"My will is yours..."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Ghost1
        [/filter]
        [message]
            speaker=Dolevan
            message=_"Well that was unfortunate...  But I still think I can do this!"
        [/message]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Dolevan
        [/filter]
        [message]
            speaker=Dolevan
            message=_"Oh, who will figure out the secret to stopping these monsters?  Surely not that fool prince and his daemon companion..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=die
        [filter]
            side=2
            [not]
                race=khthon
            [/not]
        [/filter]
        # surely there is a better filter than this.
        [filter_second]
            type=Walking Corpse, Soulless
        [/filter_second]
        [message]
            speaker=Dolevan
            message=_"Interesting, they can be re-animated..."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            race=khthon
        [/filter]
        [filter_second]
            id=Dolevan
        [/filter_second]
        [message]
            speaker=Dolevan
            message=_"Now, time to get my answers...  A battlefield seance isn't ideal, but I can move fast!"
        [/message]
	{FLASH_WHITE (
        [message]
            speaker=Dolevan
            message=_"<i>Spirit, please talk to me!  Who are you, wh-</i>"
        [/message]
	)}
        [message]
            speaker=Dolevan
            message=_"Wait, there was a second mind!  We are not alone!"
        [/message]
        [message]
            speaker=Khthon_Leader
            message=_"<i>Screeeech!</i>"
        [/message]
        [message]
            speaker=narrator
            message=_"The green-eyed beasts and their thralls were clearly terrified of something.  Those that could bolted."
        [/message]
	[kill]
	side=2
	[/kill]
        [unit]
            type=Spirit Dove
            side=4
            x,y=2,23
            id=Dove1
        [/unit]
        {MOVE_UNIT (id=Dove1) $x2 $y2}
        [message]
            speaker=Dolevan
            message=_"That's not a bird, is it..."
        [/message]
        {MOVE_UNIT (id=Dove1) 3 20}
        {MOVE_UNIT (id=Dove1) 6 23}
        [kill]
            id=Dove1
        [/kill]
        [message]
            speaker=Dolevan
            message= _ "It wants me to follow..."
        [/message]
        {MOVE_UNIT (id=Dolevan) 6 23}
        [endlevel]
            {CONTINUE}
        [/endlevel]
    [/event]

    [event]
        name=time over
        [message]
            speaker=Dolevan
            message= _ "This is taking forever..."
        [/message]
        {FADE_TO_BLACK}
        [message]
            speaker=Dolevan
            message= _ "What is happening?"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]

[scenario]
    id="3_H05b"
    name= _ "An Encounter"
    map_data="{~add-ons/Trinity/maps/3_H05.map}"
    next_scenario=3_H05c
    victory_when_enemies_defeated=no
    {TURNS 40 35 30}

    [music]
        name="nunc_dimittis.ogg"
    [/music]

    {BMR_STORE_SIDE 1}
    {BMR_RESTORE_SIDE 1}
    {FIRST_WATCH}

    [story]
        [part]
            story= _ "The group continued on without Dolevan. Prince Haldrad hoped the Necromancer would change his mind and rejoin them, but they had to move on toward Weldyn."
            background="story/landscape-bridge.jpg"
        [/part]
        [part]
            story= _ "As they approached the outer perimeter, Prince Haldrad's party saw the guard towers were manned by... Elves?"
            background="story/landscape-bridge.jpg"
        [/part]
    [/story]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Defeat Elvish Guards"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Time Runs Out"
            [/objective]
        [/objectives]
        [item]
            x=17
            y=42
            image="items/gohere.png"
        [/item]
        {GENERIC_UNIT 2 "Elvish Fighter" 19 37}
        {GUARDIAN}
        {ARCHAIC_KHTHONIZED x,y=19,37}
        {GENERIC_UNIT 2 "Elvish Archer" 15 36}
        {GUARDIAN}
        {ARCHAIC_KHTHONIZED x,y=15,36}
        {GENERIC_UNIT 2 "Elvish Captain" 17 38}
        [+unit]
            profile=portraits/elves/transparent/captain.png~BLIT(portraits/kec.png,0,0)~CS(-100,5,-5)
        [/unit]
        {GUARDIAN}
# this needs to be updated...
#        {TRINITY_KHTHONIZED x,y=17,38}
        {ARCHAIC_KHTHONIZED x,y=17,38}
        {GENERIC_UNIT 2 "Elvish Hero" 15 40}
        {GUARDIAN}
        {ARCHAIC_KHTHONIZED x,y=15,40}
        {GENERIC_UNIT 2 "Elvish Ranger" 19 40}
        {GUARDIAN}
        {ARCHAIC_KHTHONIZED x,y=19,40}
        [kill]
            id=Dolevan
        [/kill]
        [kill]
            race=undead
        [/kill]
        {GENERIC_UNIT 3 "Yak" 1 9}
        {GENERIC_UNIT 3 "Ophis" 1 20}
        {GENERIC_UNIT 3 "Prokyon" 42 11}
        {GENERIC_UNIT 3 "Noble_Beast" 42 1}
#ifdef HARD
        {GENERIC_UNIT 3 "Nightmare" 42 32}
#endif
        {GENERIC_UNIT 3 "Ram" 37 39}
        [recall]
            id=Dardrus
        [/recall]
        [set_variable]
            name=fog_here
            value=0
        [/set_variable]
    [/event]

    [side]
        type=Haldrad Fighter
        save_id=Royal
        id=Haldrad
        side=1
        canrecruit=yes
        controller=human
        fog=no
        recruit=Peasant,Woodsman,Spearman,Bowman
        {GOLD 150 125 100}
        {INCOME 6 4 2}
        team_name=Royal
    [/side]

    [side]
        no_leader=yes
        side=2
        controller=ai
        fog=no
        [ai]
            aggression=0.8
            grouping=offensive
            caution=0.9
        [/ai]
        team_name=Khthon
    [/side]

    [side]
        no_leader=yes
        side=3
        controller=ai
        fog=no
        [ai]
            aggression=0.8
            grouping=offensive
            caution=0.9
        [/ai]
        team_name=Khthon
    [/side]

    [side]
        no_leader=yes
        side=4
        controller=ai
        fog=no
        [ai]
            aggression=0.8
            grouping=offensive
            caution=0.9
        [/ai]
        team_name=Khthon
    [/side]

    [event]
        name=start
        [message]
            speaker=Haldrad
            message= _ "Elves manning the guard towers? Is the battle going so badly that the Royal Guard must be outsourced to Elves?"
        [/message]
        [scroll_to]
            x,y=17,38
        [/scroll_to]
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Dardrus
            message= _ "There is something very wrong with them... Remember when I asked about green-eyed traitors? These are the ones I was refering to..."
        [/message]
        [message]
            speaker=Haldrad
            message= _ "(So you don't like Elves...)  Elf Captain! Why do our woodland friends play the role of guardians? What has happened to the Royal Guard?"
        [/message]
        [message]
            x,y=17,38
            message= _ "Khhrrrr...."
        [/message]
        [message]
            speaker=Dardrus
            message= _ "Those were once Elves, but they are no longer Elves. They are the Enemy, set aside any hesitation for you are in great danger..."
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Yes, 'khrrr' was not the response I expected. Has Weldyn been lost? Or are we needed there to break a siege?"
        [/message]
        [set_variable]
            name=weldyn_here
            value=0
        [/set_variable]
        [music]
            name=battle.ogg
            append=no
            immediate=yes
        [/music]
    [/event]

    # somehow, not all units are Thralls or Khthon, what am I missing?
    [event]
        name=new turn
        first_time_only=no
        [set_variable]
            name=random_temp1
            rand=1..6
        [/set_variable]
        [set_variable]
            name=random_temp2
            rand=1..6
        [/set_variable]
        [set_variable]
            name=random_temp3
            rand=1..6
        [/set_variable]
        [switch]
            variable=random_temp1
            [case]
                value=1
                {GENERIC_UNIT 2 "Elvish Archer" 16 42}
                [+unit]
                    experience=$random_temp3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=16,42}
            [/case]
            [case]
                value=2
                {GENERIC_UNIT 2 "Elvish Fighter" 18 41}
                [+unit]
                    experience=$random_temp2
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=18,41}
            [/case]
            [case]
                value=3
                {GENERIC_UNIT 2 "Elvish Ranger" 17 41}
                [+unit]
                    experience=$random_temp3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=17,41}
            [/case]
            [case]
                value=4
                {GENERIC_UNIT 2 "Elvish Hero" 13 42}
                [+unit]
                    experience=$random_temp2
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=13,42}
            [/case]
            [case]
                value=5
                {GENERIC_UNIT 2 "Elvish Scout" 21 41}
                [+unit]
                    experience=$random_temp3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=21,41}
            [/case]
            [else]
                {GENERIC_UNIT 2 "Elvish Rider" 20 42}
                [+unit]
                    experience=$random_temp2
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=20,42}
            [/else]
        [/switch]
        [switch]
            variable=random_temp2
            [case]
                value=1
                {GENERIC_UNIT 3 "Horse" 2 2}
                [+unit]
                    experience=$random_temp1
                [/unit]
            [/case]
            [case]
                value=2
                {GENERIC_UNIT 3 "Noble_Beast" 1 15}
                [+unit]
                    experience=$random_temp3
                [/unit]
            [/case]
            [case]
                value=3
                {GENERIC_UNIT 3 "Ram" 1 33}
                [+unit]
                    experience=$random_temp1
                [/unit]
            [/case]
            [case]
                value=4
                {GENERIC_UNIT 3 "Ophis" 41 31}
                [+unit]
                    experience=$random_temp3
                [/unit]
            [/case]
            [case]
                value=5
                {GENERIC_UNIT 3 "Timber Wolf" 41 13}
                [+unit]
                    experience=$random_temp1
                [/unit]
            [/case]
            [else]
                {GENERIC_UNIT 3 "Prokyon" 40 2}
                [+unit]
                    experience=$random_temp3
                [/unit]
            [/else]
        [/switch]
        [if]
            [variable]
                name=weldyn_here
                equals=1
            [/variable]
            [then]
                [switch]
                    variable=random_temp3
                    [case]
                        value=1
                        {GENERIC_UNIT 4 "Spearman" 42 35}
                        [+unit]
                            experience=$random_temp2
                        [/unit]
                        {ARCHAIC_KHTHONIZED x,y=42,35}
                    [/case]
                    [case]
                        value=2
                        {GENERIC_UNIT 4 "Bowman" 1 34}
                        [+unit]
                            experience=$random_temp1
                        [/unit]
                        {ARCHAIC_KHTHONIZED x,y=1,34}
                    [/case]
                    [case]
                        value=3
                        {GENERIC_UNIT 4 "Horseman" 15 42}
                        [+unit]
                            experience=$random_temp2
                        [/unit]
                        {ARCHAIC_KHTHONIZED x,y=15,42}
                    [/case]
                    [case]
                        value=4
                        {GENERIC_UNIT 4 "Swordsman" 32 39}
                        [+unit]
                            experience=$random_temp1
                        [/unit]
                        {ARCHAIC_KHTHONIZED x,y=32,39}
                    [/case]
                    [case]
                        value=5
                        {GENERIC_UNIT 4 "Longbowman" 40 25}
                        [+unit]
                            experience=$random_temp2
                        [/unit]
                        {ARCHAIC_KHTHONIZED x,y=40,25}
                    [/case]
                    [else]
                        {GENERIC_UNIT 4 "Knight" 18 41}
                        [+unit]
                            experience=$random_temp1
                        [/unit]
                        {ARCHAIC_KHTHONIZED x,y=18,41}
                    [/else]
                [/switch]
            [/then]
        [/if]
        {CLEAR_VARIABLE random_temp1}
        {CLEAR_VARIABLE random_temp2}
        {CLEAR_VARIABLE random_temp3}
    [/event]

    # Check this before using, I'm not sure the [and] & [or] stuff is right
    #    [event]
    #        name=moveto
    #        [filter]
    #            y=22-42
    #            id=Dardrus
    #                [or]
    #                        id=Haldrad
    #	                y=22-42
    #                [/or]
    #        [/filter]
    #        [set_variable]
    #            name=fog_here
    #            value=1
    #        [/set_variable]
    #    [/event]

    [event]
        name=moveto
        [filter]
            id=Haldrad
            y=22-42
        [/filter]
        [set_variable]
            name=fog_here
            value=1
        [/set_variable]
    [/event]

    [event]
        name=new turn
        first_time_only=no
        [if]
            [variable]
                name=fog_here
                numerical_equals=1
            [/variable]
            [then]
                [message]
                    speaker=Dardrus
                    message= _ "More fog..."
                [/message]
                [modify_side]
                    side=1
                    fog=yes
                [/modify_side]
                [message]
                    speaker=Haldrad
                    message= _ "This is not a drainage or coast, I've never seen fog like this here..."
                [/message]
                [message]
                    speaker=Dardrus
                    message= _ "You are right, there is something ominous."
                [/message]
                [music]
                    name=siege_of_laurelmor.ogg
                    append=no
                    immediate=yes
                [/music]
                [set_variable]
                    name=weldyn_here
                    add=1
                [/set_variable]
                {CLEAR_VARIABLE fog_here}
            [/then]
        [/if]
    [/event]

    [event]
        name=attack_end
        [filter]
            side=4
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "Former friends..."
        [/message]
        [message]
            speaker=Haldrad
            message= _ "It is quite unnerving."
        [/message]
    [/event]

    [event]
        name=turn 6
        [set_variable]
            name=weldyn_here
            add=1
        [/set_variable]
    [/event]

    # the player got to the target hex
    [event]
        name=moveto
        [filter]
            x=14-20
            y=40-42
            [and]
                id=Dardrus
                [or]
                    id=Haldrad
                [/or]
            [/and]
        [/filter]
        [fire_event]
            name=weldyn_comes
        [/fire_event]
    [/event]

    # the scenario is dragging on...
    [event]
        name=new turn
        first_time_only=no
        [if]
            [variable]
                name=weldyn_here
                numerical_equals=2
            [/variable]
            [then]
                [fire_event]
                    name=weldyn_comes
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name=weldyn_comes
        [message]
            speaker=Haldrad
            message= _ "I do not like how this is going, these are not interceptors come to keep us from saving Weldyn. Weldyn is lost, we should head to Elensefar; it is the next largest city and if we can assist in its defense, the kingdom may yet survive."
        [/message]
        [message]
            speaker=Dardrus
            message= _ "That may be, but I would suggest we head into the mountains to the north. We may be able to find help there."
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Are you suggesting we hide with the Dwarves? That I will never do! They would not let us in anyway, our relations are a bit strained these days."
        [/message]
        [message]
            speaker=Dardrus
            message= _ "What is 'the Dwarves'? I have something else in mind-"
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Fine! Either way we need to head north of here. Let us escape to the north, and we will figure out where to go from there."
        [/message]
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Haldrad reaches the northern edge of map"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Time Runs Out"
            [/objective]
        [/objectives]
        # if the player is trying to game the system...
        [store_unit]
            [filter]
                id=Haldrad
            [/filter]
            variable=haldrad
            kill=no
        [/store_unit]
        [if]
            [variable]
                name=haldrad.y
                less_than=13
            [/variable]
            [then]
                {GENERIC_UNIT 4 "Elvish Sharpshooter" 12 1}
                [+unit]
                    experience=3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=12,1}
                {GENERIC_UNIT 4 "Elvish Champion" 15 1}
                [+unit]
                    experience=3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=15,1}
                {GENERIC_UNIT 4 "Elvish Outrider" 21 1}
                [+unit]
                    experience=3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=21,1}
                {GENERIC_UNIT 4 "Elvish Hero" 26 1}
                [+unit]
                    experience=3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=26,1}
                {GENERIC_UNIT 4 "Grand Knight" 17 42}
                [+unit]
                    experience=3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=17,42}
                {GENERIC_UNIT 4 "Grand Knight" 18 40}
                [+unit]
                    experience=3
                [/unit]
                {ARCHAIC_KHTHONIZED x,y=18,40}
            [/then]
        [/if]
        {CLEAR_VARIABLE haldrad}
        [remove_item]
            x,y=17,42
        [/remove_item]
        [item]
            x=13
            y=1
            image="items/gohere.png"
        [/item]
        # so this event doesn't fire again, and player wins if makes it to north edge
        [set_variable]
            name=weldyn_here
            add=1
        [/set_variable]
        [event]
            name=moveto
            [filter]
                id=Haldrad
                y=1-8
            [/filter]
            [unit]
                type=Dragoon
                side=1
                id=Dragoon1
                x,y=15,1
            [/unit]
            {MOVE_UNIT (id=Dragoon1) 16 3}
            [message]
                speaker=Dragoon1
                message=_"Prince Haldrad, praise the gods!  You know Weldyn is lost, right?"
            [/message]
            [message]
                speaker=Haldrad
                message=_"Yes, the thought has occured to me.  What are you doing?"
            [/message]
            [message]
                speaker=Dragoon1
                message=_"Well, I've been guarding the retreating forces.  Prince, we need to get you out of here!  Queen Caldera would kill me if anything should happen to you!"
            [/message]
            [message]
                speaker=Haldrad
                message=_"Would she?  She's still alive?"
            [/message]
            [message]
                speaker=Dragoon1
                message=_"Yes!  The enemy knew when to strike!  Only Ryaeron, Saleanna, and Daenyr were in Weldyn to defend the city when we were attacked.  You were off to fetch Advisor Dolevan, the Queen was off to Elensefar, and Advisor Lyron had been dispatched to Carcyn.  We were at our weakest!"
            [/message]
            [message]
                speaker=Haldrad
                message=_"This is good news - well, relatively good news.  Weldyn has fallen, but our Kingdom's forces have not yet been defeated.  We shall go to Elensefar!"
            [/message]
        [/event]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Haldrad
            y=1-2
        [/filter]
        [if]
            [variable]
                name=weldyn_here
                numerical_equals=3
            [/variable]
            [then]
                [message]
                    speaker=Haldrad
                    message= _ "We are no longer surrounded, but the enemy will catch up if we don't keep moving!"
                [/message]
                {CLEAR_VARIABLE weldyn_here}
                [endlevel]
                    {CONTINUE}
                [/endlevel]
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        [filter]
            id=Dardrus
        [/filter]
        [message]
            speaker=Haldrad
            message= _ "Oh, this is not good..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=die
        [filter]
            id=Haldrad
        [/filter]
        [message]
            speaker=Dardrus
            message= _ "Well, so much for that..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=time over
        [message]
            speaker=Haldrad
            message= _ "We are being over-run. I see movement on all sides, there is no escape."
        [/message]
        {FADE_TO_BLACK}
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]

[scenario]
    id="3_H05c"
#    id="3_H05b"
    name= _ "Seth"
    map_data="{~add-ons/Trinity/maps/damned_tower/outside.map}"
    next_scenario=3_P05
#    next_scenario=3_H05c
    victory_when_enemies_defeated=no
    {TURNS 25 15 10}

    [music]
        name="nunc_dimittis.ogg"
    [/music]

    #	{BMR_STORE_SIDE 1}
    #	{BMR_RESTORE_SIDE 1}
    {FIRST_WATCH}

    [story]
        [part]
            story= _ "Dolevan followed the ghostly dove toward the ruins of Weldyn.  As he did so, he noticed the darkening of the sky and the seeming rot of the earth."
            background="story/Trinity_maelstrom.jpg"
        [/part]
        [part]
            story= _ "The rot seemed to get worse and worse as he continued.  One might think a Necromancer would feel at home, but what the Necromancers pursue is a form of stasis, and there was nothing hinting at stasis in what Dolevan saw.  There was only decay, ruin, and (most disturbingly) a sense of finality.  It was like death, but on a higher level.  Dolevan choked down his unease, and continued to follow the dove."
            background="story/Trinity_maelstrom.jpg"
        [/part]
        [part]
            story= _ "Eventually, they reached the vicinity of the capital, and where the Royal Palace once stood was a tall, ominous tower.  Dolevan felt he was going to learn about the monsters destroying his world, but feared his part in this story would not extend much beyond that."
            background="story/Trinity_tower.jpg"
        [/part]
    [/story]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=lose
                description=_ "Time Runs Out"
            [/objective]
            note=_"This is the only scenario where you play as Dolevan."
        [/objectives]
        [unit]
            type=Spirit Dove
            side=2
            id=Dove1
            x,y=15,89
        [/unit]
        {TELEPORT_UNIT (id=Dolevan) 15 90}
        [item]
            x,y=15,74
            image=misc/skull-banner.png
        [/item]
    [/event]

    [side]
        type=Necromancer
        #	save_id=Royal
        name="Dolevan"
        id=Dolevan
        side=1
        canrecruit=yes
        controller=human
        fog=no
        recruit=Skeleton, Skeleton Archer, Walking Corpse
        {GOLD 150 125 100}
        {INCOME 6 4 2}
        team_name=Undead
    [/side]

    [side]
        type=Seth
        id=Seth
        canrecruit=yes
        recruit=Tomb Guard
        side=2
        controller=ai
        fog=no
        {GOLD 100 150 200}
        {INCOME 2 5 8}
        [ai]
            aggression=0.8
            grouping=offensive
            caution=0.9
        [/ai]
        team_name=Phantom
        [unit]
            type=Tomb Shield
            id=Shield1
            x,y=18,81
            facing=sw
        [/unit]
        [unit]
            type=Tomb Shield
            id=Shield2
            x,y=13,81
            facing=se
        [/unit]
        [unit]
            type=Tomb Protector
            id=Protector1
            x,y=16,77
            facing=sw
        [/unit]
    [/side]

    [event]
        name=start
        [message]
            speaker=Dolevan
            message= _ "Well, Dove?  Here we are..."
        [/message]
        {MOVE_UNIT (id=Dove1) 15 84}
        [message]
            speaker=Dolevan
            message= _ "Those must be your masters up ahead, Dove..."
        [/message]
        {MOVE_UNIT (id=Dolevan) 15 85}
        {MOVE_UNIT (id=Dove1) 14 77}
        [message]
            speaker=Seth
            message= _ "Welcome, wise one...  We met before, but it was oh-so brief - too brief.  I am Seth."
        [/message]
        {MOVE_UNIT (id=Dolevan) 15 81}
        [scroll_to]
            x,y=15,76
        [/scroll_to]
        [message]
            speaker=Dolevan
            message= _ "And I am Dolevan...  You say we have met?"
        [/message]
        [message]
            speaker=Seth
            message= _ "Yes, briefly, when you tried to talk to the spirit of that beast you slayed.  It was too brief for me to gather much, but I could recognize a fellow soul.  Tell me, do you like what I've created here?"
        [/message]
        [message]
            speaker=Dolevan
            message= _ "It is... impressive... in it's own way, I suppose.  How are we fellow souls?"
        [/message]
        [message]
            speaker=Seth
            message= _ "You do not wish to perish and become something else, you go to great lengths to ensure that death does not change you to something too far from what your current form."
        [/message]
        [message]
            speaker=Seth
            message= _ "I am the same, I do not wish to change.  In a former life, I was a high-ranking scribe and priest for this world's most powerful empire.  Then a god came down, and a great battle ensued.  The god was defeated, and changed.  I was part of that change - I changed, I became part of that god."
        [/message]
        [message]
            speaker=Dolevan
            message= _ "That change was a form of death?"
        [/message]
        [message]
            speaker=Seth
            message= _ "Yes, it was terrible.  I cannot allow it to happen again, I will not allow us to fall farther from our former godly existance - I will restore our godly existance."
        [/message]
        [message]
            speaker=Dolevan
            message= _ "'Our'?"
        [/message]
        [message]
            speaker=Seth
            message= _ "The green-eyed beasts are fragments of my god, but they embrace the change, and make it harder to restore our god.  And they are not the only ones; so much of this world has little fragments of my god scattered throughout.  Which is why I brought you here."
        [/message]
        [music]
            name=One_Thousand_Suns.ogg
            append=no
            immediate=yes
        [/music]
        [message]
            speaker=Seth
            message= _ "I must unravel the knots of change made by Khthon interaction in this world, I must reclaim all of the pieces scattered throughout the land.  This tower shall be my means to that end."
        [/message]
        [message]
            speaker=Dolevan
            message= _ "This tower will?  What does it have to do with me?"
        [/message]
        [message]
            speaker=Seth
            message= _ "The tower draws the scattered pieces inward, stripping them out of the native parts of this world.  It will eventually accomplish my task, and restore our god, but as you may have noticed, there is a lot of collateral dammage.  The Khthon, as well as the native denizens of this world, will not sit passively by - they will try to disrupt this process.  They will fear and hate us, a reception with which I know you are familiar.

Will you join me in defeating the forces of this world, and bringing the green-eyed beings back to the fold?  Will you help me restore my god?"
        [/message]
        [message]
            speaker=Dolevan
            message= _ "No!  I've seen enough to know that I want no part of this!  I'm leaving!"
        [/message]
        [message]
            speaker=Seth
            message= _ "I think you know that is not an option..."
        [/message]
        {MOVE_UNIT id=Seth 15 80}
        [animate_unit]
            flag=attack
            [filter]
                id=Seth
            [/filter]
            [primary_attack]
                range=ranged
            [/primary_attack]
            [facing]
                x,y=15,81
            [/facing]
            hits=yes
        [/animate_unit]
        [message]
            speaker=Dolevan
            message= _ "<i>(Gasp!)</i>  You knew I'd think you an abomination, you know we are not the same...  <i>(groan)</i>  Why did you bring me here?"
        [/message]
        [message]
            speaker=Seth
            message= _ "I needed a form, to retrieve my foolish Echidna.  You were the most tolerable.  This would have been easier had you joined me, but I can still use your arts and minions as a diversion."
        [/message]
        	[kill]
        	id=Dolevan
        	animate=yes
        	[/kill]
        [message]
            speaker=Seth
            message= _ "It would give you some small pleasure to know that my presence here has caused me to change again.  But I must take this step into depravity to pull us clear!"
        [/message]
        {MOVE_UNIT (id=Seth) 15 78}
        [message]
            speaker=Seth
            message= _ "And so it begins..."
        [/message]
        	[endlevel]
        	   {CONTINUE}
        	   replay_save=no
        	[/endlevel]
    [/event]
[/scenario]

